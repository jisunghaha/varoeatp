<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>바로잇 (BaroEat)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=YOUR_APP_KEY"></script>
    <script src="https://cdn.iamport.kr/v1/iamport.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap');

        body {
            font-family: 'Noto Sans KR', sans-serif;
        }

        .hidden {
            display: none;
        }

        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }

        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>

<body class="bg-gray-100 h-screen flex flex-col">

    <!-- Header -->
    <header class="bg-white shadow-md p-4 flex justify-between items-center z-10">
        <h1 class="text-2xl font-bold text-orange-600 cursor-pointer" onclick="handleNavigate('home')">바로잇</h1>
        <div id="auth-buttons">
            <!-- 로그인 상태에 따라 버튼 변경 -->
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 flex overflow-hidden relative">
        <!-- Sidebar (Store List) -->
        <aside id="sidebar" class="w-1/3 bg-white border-r overflow-y-auto hidden md:block z-10">
            <div class="p-4 border-b">
                <h2 class="text-xl font-bold mb-2">내 주변 맛집</h2>
                <div class="flex space-x-2 overflow-x-auto scrollbar-hide">
                    <button onclick="filterStores('all')"
                        class="px-3 py-1 bg-orange-500 text-white rounded-full text-sm whitespace-nowrap store-filter-btn"
                        data-cat="all">전체</button>
                    <button onclick="filterStores('한식')"
                        class="px-3 py-1 bg-gray-200 text-gray-700 rounded-full text-sm whitespace-nowrap store-filter-btn hover:bg-gray-300"
                        data-cat="한식">한식</button>
                    <button onclick="filterStores('양식')"
                        class="px-3 py-1 bg-gray-200 text-gray-700 rounded-full text-sm whitespace-nowrap store-filter-btn hover:bg-gray-300"
                        data-cat="양식">양식</button>
                    <button onclick="filterStores('주점')"
                        class="px-3 py-1 bg-gray-200 text-gray-700 rounded-full text-sm whitespace-nowrap store-filter-btn hover:bg-gray-300"
                        data-cat="주점">주점</button>
                </div>
            </div>
            <div id="store-list-sidebar">
                <div class="p-4 text-center text-gray-500">매장을 불러오는 중...</div>
            </div>
        </aside>

        <!-- Map Area -->
        <div id="map" class="flex-1 bg-gray-200 relative z-0">
            <!-- 지도 -->
        </div>

        <!-- View Container -->
        <div id="view-container" class="absolute inset-0 bg-white z-20 hidden overflow-y-auto">
            <!-- 동적으로 뷰가 렌더링 됩니다 -->
        </div>
    </main>

    <script>
        // --- State Management ---
        let currentView = 'home';
        let currentUser = null; // Display name (Nickname or Email)
        let currentUserEmail = null; // Actual Email
        let currentStoreId = null;
        let selectedMenus = {};
        let menuData = [];
        let currentTablePrice = 0;

        let notifiedReservations = new Set(); // To prevent duplicate alerts
        let currentCategory = 'all'; // Track current menu category
        let currentStoreCategory = 'all'; // Track current store category
        let favoriteStoreIds = new Set(); // Track favorite stores
        let allStores = []; // Cache all stores
        const apiUrl = '/api/auth';

        // PortOne Init
        IMP.init('imp82508375');

        // Category-based estimated time (in minutes)
        const categoryTimeMap = {
            '국밥': 10,
            '찌개': 15,
            '볶음': 15,
            '사이드': 5,
            '음료': 0,
            '주류': 0,
            '기타': 10
        };

        // --- Navigation Handler ---
        function handleNavigate(view, param = null) {
            currentView = view;
            if (view === 'store-detail') currentStoreId = param;
            if (view === 'reservation') {
                selectedMenus = {};
                currentTablePrice = 0;
            }
            render();
        }

        // --- Render Function ---
        function updateHeader() {
            const authButtons = document.getElementById('auth-buttons');
            let navLinks = `
                <button onclick="handleNavigate('home')" class="text-gray-600 hover:text-orange-600 mr-4 font-bold">홈</button>
                <button onclick="handleNavigate('community')" class="text-gray-600 hover:text-orange-600 mr-4 font-bold">커뮤니티</button>
            `;

            if (currentUser) {
                authButtons.innerHTML = navLinks + `
                    <span class="mr-4 text-gray-700">안녕하세요, ${currentUser}님</span>
                    <button onclick="handleNavigate('mypage')" class="text-gray-600 hover:text-orange-600 mr-4">마이페이지</button>
                    <button onclick="handleLogout()" class="bg-gray-200 px-4 py-2 rounded hover:bg-gray-300">로그아웃</button>
                `;
            } else {
                authButtons.innerHTML = navLinks + `
                    <button onclick="handleNavigate('login')" class="text-gray-600 hover:text-orange-600 mr-4">로그인</button>
                    <button onclick="handleNavigate('signup')" class="bg-orange-500 text-white px-4 py-2 rounded hover:bg-orange-600">회원가입</button>
                `;
            }
        }

        function render() {
            const viewContainer = document.getElementById('view-container');
            const sidebar = document.getElementById('sidebar');
            const map = document.getElementById('map');

            updateHeader();

            // View Routing
            if (currentView === 'home') {
                viewContainer.classList.add('hidden');
                sidebar.classList.remove('hidden');
                map.classList.remove('hidden');
                loadStoresAndMap();
            } else if (currentView === 'community') {
                viewContainer.classList.remove('hidden');
                viewContainer.innerHTML = `
                    <div class="max-w-4xl mx-auto p-4">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-3xl font-bold">커뮤니티</h2>
                            <button onclick="openWriteReviewModal()" class="bg-orange-500 text-white px-4 py-2 rounded font-bold hover:bg-orange-600">글쓰기</button>
                        </div>
                        <div id="review-list" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <p class="text-gray-500">리뷰를 불러오는 중...</p>
                        </div>
                    
                    <!-- Write Review Modal -->
                    <div id="write-review-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
                        <div class="bg-white p-6 rounded-lg w-full max-w-lg">
                            <h3 class="text-xl font-bold mb-4">리뷰 작성</h3>
                            <div class="mb-4">
                                <label class="block font-bold mb-2">매장 선택 (선택사항)</label>
                                <select id="review-store-select" class="w-full p-2 border rounded">
                                    <option value="">매장 선택 안함</option>
                                    <!-- Stores will be loaded here -->
                                </select>
                            </div>
                            <div class="mb-4">
                                <label class="block font-bold mb-2">내용</label>
                                <textarea id="review-content" class="w-full p-2 border rounded h-32" placeholder="리뷰 내용을 입력하세요"></textarea>
                            </div>
                            <div class="mb-4">
                                <label class="block font-bold mb-2">사진 첨부</label>
                                <input type="file" id="review-image" accept="image/*" class="w-full p-2 border rounded">
                            </div>
                            <div class="flex justify-end space-x-2">
                                <button onclick="closeWriteReviewModal()" class="px-4 py-2 bg-gray-200 rounded">취소</button>
                                <button onclick="submitReview()" class="px-4 py-2 bg-orange-500 text-white rounded font-bold">등록</button>
                            </div>
                        </div>
                    </div>
                `;
                loadCommunity();
            } else if (currentView === 'login') {
                // ... (login view content)
                viewContainer.classList.remove('hidden');
                viewContainer.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-full p-4">
                        <div class="w-full max-w-md bg-white p-8 rounded-lg shadow-lg">
                            <h2 class="text-2xl font-bold mb-6 text-center">로그인</h2>
                            <input type="email" id="login-email" placeholder="이메일" class="w-full p-3 mb-4 border rounded">
                            <input type="password" id="login-password" placeholder="비밀번호" class="w-full p-3 mb-6 border rounded">
                            <button onclick="handleBackendLogin()" class="w-full bg-orange-500 text-white p-3 rounded font-bold mb-4">로그인</button>
                            <a href="/oauth2/authorization/kakao" class="block w-full bg-yellow-400 text-black p-3 rounded font-bold text-center mb-4">카카오 로그인</a>
                            <button onclick="handleNavigate('home')" class="w-full text-gray-500">취소</button>
                            <p id="login-message" class="text-red-500 mt-4 text-center"></p>
                        </div>
                    </div>
                `;
            } else if (currentView === 'signup') {
                // ... (signup view content)
                viewContainer.classList.remove('hidden');
                viewContainer.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-full p-4">
                        <div class="w-full max-w-md bg-white p-8 rounded-lg shadow-lg">
                            <h2 class="text-2xl font-bold mb-6 text-center">회원가입</h2>
                            <input type="text" id="signup-user-name" placeholder="이름" class="w-full p-3 mb-4 border rounded">
                            <input type="email" id="signup-email" placeholder="이메일" class="w-full p-3 mb-4 border rounded">
                            <input type="tel" id="signup-phone-number" placeholder="전화번호" class="w-full p-3 mb-4 border rounded">
                            <input type="password" id="signup-password" placeholder="비밀번호" class="w-full p-3 mb-6 border rounded">
                            <button onclick="handleBackendSignup()" class="w-full bg-orange-500 text-white p-3 rounded font-bold mb-4">가입하기</button>
                            <button onclick="handleNavigate('home')" class="w-full text-gray-500">취소</button>
                            <p id="signup-message" class="text-red-500 mt-4 text-center"></p>
                        </div>
                    </div>
                `;
            } else if (currentView === 'mypage') {
                // ... (mypage content)
                viewContainer.classList.remove('hidden');
                viewContainer.innerHTML = `
                    <div class="max-w-2xl mx-auto p-6">
                        <h2 class="text-3xl font-bold mb-6">마이페이지</h2>
                        <div class="bg-white p-6 rounded-lg shadow mb-6">
                            <div class="space-y-4">
                                <div class="flex justify-between border-b pb-4">
                                    <span class="font-bold text-gray-600">이메일</span>
                                    <span id="mypage-email" class="text-gray-800">로딩중...</span>
                                </div>
                                <div class="mb-4">
                                    <label class="block font-bold text-gray-600 mb-2">별명</label>
                                    <input type="text" id="mypage-nickname" class="w-full p-2 border rounded" placeholder="별명을 입력하세요">
                                </div>
                                <div class="mb-4">
                                    <label class="block font-bold text-gray-600 mb-2">선호하는 음식</label>
                                    <input type="text" id="mypage-food" class="w-full p-2 border rounded" placeholder="예: 국밥, 찌개">
                                </div>
                                <button onclick="updateMyPageInfo()" class="w-full bg-orange-500 text-white px-4 py-2 rounded hover:bg-orange-600 font-bold">정보 수정 저장</button>
                            </div>
                        </div>
                        
                        <div class="bg-white p-6 rounded-lg shadow">
                            <h3 class="text-xl font-bold mb-4 text-red-600">회원 탈퇴</h3>
                            <p class="text-gray-600 mb-4">탈퇴 시 모든 정보가 삭제되며 복구할 수 없습니다.</p>
                            <input type="password" id="withdraw-password" placeholder="비밀번호 확인" class="w-full p-2 border rounded mb-4">
                            <button onclick="handleWithdraw()" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">회원 탈퇴</button>
                            <p id="mypage-message" class="text-red-500 mt-2"></p>
                        </div>
                        <button onclick="handleNavigate('home')" class="mt-6 text-gray-500 underline">메인으로 돌아가기</button>
                    </div>
                `;
                loadMyPageInfo();
            } else if (currentView === 'store-detail') {
                // ... (store detail content)
                viewContainer.classList.remove('hidden');
                viewContainer.innerHTML = `
                    <div class="max-w-4xl mx-auto p-4">
                        <button onclick="handleNavigate('home')" class="mb-4 text-gray-600">← 뒤로가기</button>
                        <div id="store-detail-content" class="bg-white p-6 rounded-lg shadow">
                            Loading...
                        </div>
                    </div>
                `;
                loadStoreDetail();
            } else if (currentView === 'store-menu') {
                // ... (store menu content)
                viewContainer.classList.remove('hidden');
                viewContainer.innerHTML = `
                    <div class="max-w-4xl mx-auto p-4">
                        <button onclick="handleNavigate('store-detail', currentStoreId)" class="mb-4 text-gray-600">← 뒤로가기</button>
                        <div id="menu-category-content" class="bg-white p-6 rounded-lg shadow">
                            Loading...
                        </div>
                    </div>
                `;
                loadStoreMenu();
            } else if (currentView === 'reservation') {
                // ... (reservation content)
                viewContainer.classList.remove('hidden');
                viewContainer.innerHTML = `
                    <div class="max-w-4xl mx-auto p-4">
                        <button onclick="handleNavigate('store-detail', currentStoreId)" class="mb-4 text-gray-600">← 뒤로가기</button>
                        <div class="bg-white p-6 rounded-lg shadow">
                            <h2 class="text-2xl font-bold mb-6">테이블 및 메뉴 예약</h2>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <h3 class="text-lg font-bold mb-4 border-b pb-2">1. 예약 정보</h3>
                                    <div class="mb-4">
                                        <label class="block font-bold mb-2">날짜 선택</label>
                                        <input type="date" id="res-date" class="w-full p-2 border rounded" onchange="loadAvailableTimes()">
                                    </div>
                                    <div class="mb-4">
                                        <label class="block font-bold mb-2">시간 선택</label>
                                        <select id="res-time" class="w-full p-2 border rounded" disabled onchange="loadAvailableTables()">
                                            <option value="">날짜를 먼저 선택하세요</option>
                                        </select>
                                    </div>
                                    <div class="mb-4">
                                        <label class="block font-bold mb-2">인원 수</label>
                                        <select id="res-party-size" class="w-full p-2 border rounded" onchange="loadAvailableTables()">
                                            <option value="1">1명</option>
                                            <option value="2">2명</option>
                                            <option value="3">3명</option>
                                            <option value="4">4명</option>
                                            <option value="5">5명</option>
                                            <option value="6">6명</option>
                                            <option value="7">7명</option>
                                            <option value="8">8명</option>
                                        </select>
                                    </div>
                                    <div class="mb-4">
                                        <label class="block font-bold mb-2">테이블 선택</label>
                                        <div id="res-table-list" class="grid grid-cols-1 gap-4 border p-4 rounded min-h-[100px] max-h-[300px] overflow-y-auto">
                                            <p class="text-gray-500">날짜, 시간, 인원을 선택하면 가능한 테이블이 표시됩니다.</p>
                                        </div>
                                        <input type="hidden" id="res-table-id">
                                    </div>
                                </div>
                                <div>
                                    <h3 class="text-lg font-bold mb-4 border-b pb-2">2. 메뉴 선택</h3>
                                    <div id="menu-categories" class="flex space-x-2 overflow-x-auto pb-2 mb-4 scrollbar-hide">
                                        <!-- Categories will be loaded here -->
                                    </div>
                                    <div id="menu-list" class="space-y-4 max-h-[400px] overflow-y-auto pr-2">
                                        <p class="text-gray-500">메뉴를 불러오는 중...</p>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-8 border-t pt-6">
                                <div class="mb-6">
                                    <h3 class="text-lg font-bold mb-2">3. 결제 수단 선택</h3>
                                    <div class="flex space-x-4">
                                        <label class="flex items-center space-x-2 cursor-pointer">
                                            <input type="radio" name="payment-method" value="ON_SITE" checked class="form-radio text-orange-600">
                                            <span>현장 결제</span>
                                        </label>
                                        <label class="flex items-center space-x-2 cursor-pointer">
                                            <input type="radio" name="payment-method" value="CARD" class="form-radio text-orange-600">
                                            <span>카드 결제</span>
                                        </label>
                                    </div>
                                </div>
                                <div class="flex justify-between items-center mb-4">
                                    <div class="text-gray-600">
                                        <p>예상 준비 시간: <span id="est-time" class="font-bold text-orange-600">0분</span></p>
                                    </div>
                                    <div class="text-right">
                                        <p class="text-sm text-gray-500">테이블 비용 + 메뉴 비용</p>
                                        <p class="text-3xl font-bold text-orange-600" id="total-price">0원</p>
                                    </div>
                                </div>
                                <button type="button" onclick="handleReservationSubmit(event)" class="w-full bg-orange-600 text-white py-4 rounded-lg font-bold text-xl hover:bg-orange-700 shadow-lg">
                                    예약 및 결제 확정하기
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('res-date').min = today;
                loadReservationMenus();
            }
        }

        // --- API Calls & Logic ---

        window.onload = async () => {
            await checkLoginStatus();
            render();
            // Start Notification Polling
            setInterval(checkUpcomingReservations, 60000); // Check every minute
        };

        async function checkLoginStatus() {
            // ... (existing checkLoginStatus)
            try {
                const response = await fetch('/api/auth/me');
                if (response.ok) {
                    const email = await response.text();
                    currentUserEmail = email;
                    // Fetch full profile to get nickname
                    try {
                        const profileRes = await fetch('/user/mypage');
                        if (profileRes.ok) {
                            const profile = await profileRes.json();
                            currentUser = profile.nickname || profile.email;
                        } else {
                            currentUser = email;
                        }
                        // Load Favorites
                        await loadFavorites();
                    } catch (e) {
                        currentUser = email;
                    }
                } else {
                    currentUser = null;
                    currentUserEmail = null;
                    favoriteStoreIds.clear();
                }
            } catch (e) {
                currentUser = null;
                currentUserEmail = null;
                favoriteStoreIds.clear();
            }
        }

        async function loadFavorites() {
            try {
                const res = await fetch('/api/favorites');
                if (res.ok) {
                    const ids = await res.json();
                    favoriteStoreIds = new Set(ids);
                }
            } catch (e) { console.error('Failed to load favorites', e); }
        }

        async function toggleFavorite(storeId) {
            // ... (existing toggleFavorite)
            console.log('toggleFavorite called for store:', storeId);
            if (!currentUser) {
                alert('로그인이 필요합니다.');
                handleNavigate('login');
                return;
            }
            try {
                const res = await fetch(`/api/favorites/${storeId}`, { method: 'POST' });
                if (res.ok) {
                    const status = await res.text();
                    if (status === 'added') favoriteStoreIds.add(storeId);
                    else favoriteStoreIds.delete(storeId);

                    // Update UI if on store detail page
                    if (currentView === 'store-detail' && currentStoreId === storeId) {
                        updateFavoriteIcon(storeId);
                    }
                    // Reload sidebar to reflect changes
                    loadStoresAndMap();
                } else {
                    const errorText = await res.text();
                    alert('즐겨찾기 처리 실패: ' + errorText);
                    console.error('Favorite toggle failed:', res.status, errorText);
                }
            } catch (e) {
                alert('오류 발생: ' + e.message);
                console.error('Favorite toggle error:', e);
            }
        }

        function updateFavoriteIcon(storeId) {
            // ... (existing updateFavoriteIcon)
            const icon = document.getElementById('fav-icon');
            if (icon) {
                if (favoriteStoreIds.has(storeId)) {
                    icon.textContent = '★';
                    icon.classList.add('text-yellow-400');
                    icon.classList.remove('text-gray-300');
                } else {
                    icon.textContent = '☆';
                    icon.classList.add('text-gray-300');
                    icon.classList.remove('text-yellow-400');
                }
            }
        }

        function filterStores(category) {
            currentStoreCategory = category;

            // Update button styles
            document.querySelectorAll('.store-filter-btn').forEach(btn => {
                if (btn.dataset.cat === category) {
                    btn.classList.remove('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
                    btn.classList.add('bg-orange-500', 'text-white');
                } else {
                    btn.classList.add('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
                    btn.classList.remove('bg-orange-500', 'text-white');
                }
            });

            renderStoreList(allStores);
        }

        async function loadStoresAndMap() {
            const listSidebar = document.getElementById('store-list-sidebar');
            let map = null;

            if (typeof kakao !== 'undefined' && kakao.maps) {
                const mapContainer = document.getElementById('map');
                const mapOption = {
                    center: new kakao.maps.LatLng(35.148, 129.038),
                    level: 4
                };
                map = new kakao.maps.Map(mapContainer, mapOption);
            }

            try {
                // Fetch only if not cached or force reload (simplified: always fetch for now to get latest data)
                const response = await fetch('/api/stores');
                if (!response.ok) throw new Error('서버에서 매장 목록을 가져오지 못했습니다.');
                allStores = await response.json();

                renderStoreList(allStores, map);

            } catch (error) {
                console.error(error);
                listSidebar.innerHTML = `<p class="text-red-500">Error: ${error.message}</p>`;
            }
        }

        function renderStoreList(stores, map) {
            const listSidebar = document.getElementById('store-list-sidebar');

            // Filter by category
            let filteredStores = stores;
            if (currentStoreCategory !== 'all') {
                filteredStores = stores.filter(s => s.category === currentStoreCategory);
            }

            if (filteredStores.length === 0) {
                listSidebar.innerHTML = '<p class="p-4 text-gray-500">해당 카테고리의 매장이 없습니다.</p>';
                return;
            }
            listSidebar.innerHTML = '';

            // Separate favorites
            const favorites = filteredStores.filter(s => favoriteStoreIds.has(s.id));
            const others = filteredStores.filter(s => !favoriteStoreIds.has(s.id));

            if (favorites.length > 0) {
                const favHeader = document.createElement('div');
                favHeader.className = 'p-2 bg-yellow-50 font-bold text-yellow-600 border-b';
                favHeader.textContent = '★ 즐겨찾는 매장';
                listSidebar.appendChild(favHeader);

                favorites.forEach(store => createStoreListItem(store, listSidebar, map));
            }

            if (others.length > 0) {
                const otherHeader = document.createElement('div');
                otherHeader.className = 'p-2 bg-gray-50 font-bold text-gray-600 border-b';
                otherHeader.textContent = '모든 매장';
                listSidebar.appendChild(otherHeader);

                others.forEach(store => createStoreListItem(store, listSidebar, map));
            }

            // Update Map Markers (if map exists)
            // Note: Map markers should ideally be cleared and re-added. 
            // For simplicity, we are re-creating the map in loadStoresAndMap, but filterStores calls renderStoreList without map.
            // If we want to update map on filter, we need to handle map markers.
            // Let's assume map is static for now or re-render map if needed.
            // Actually, let's try to update map center if we have stores.
            if (map && filteredStores.length > 0) {
                map.setCenter(new kakao.maps.LatLng(parseFloat(filteredStores[0].lat), parseFloat(filteredStores[0].lng)));
            }
        }

        function createStoreListItem(store, container, map) {
            const lat = parseFloat(store.lat);
            const lng = parseFloat(store.lng);
            if (map && !isNaN(lat) && !isNaN(lng)) {
                const position = new kakao.maps.LatLng(lat, lng);
                const marker = new kakao.maps.Marker({ position: position, title: store.storeName });
                marker.setMap(map);
                kakao.maps.event.addListener(marker, 'click', function () { handleNavigate('store-detail', store.id); });
            }
            const storeEl = document.createElement('div');
            storeEl.className = 'p-4 border-b hover:bg-gray-100 cursor-pointer flex justify-between items-center';
            storeEl.onclick = () => handleNavigate('store-detail', store.id);

            const isFav = favoriteStoreIds.has(store.id);
            storeEl.innerHTML = `
                <div>
                    <h3 class="font-bold text-lg flex items-center">
                        ${store.storeName}
                        ${isFav ? '<span class="text-yellow-400 ml-2">★</span>' : ''}
                    </h3>
                    <p class="text-sm text-gray-600">${store.address}</p>
                </div>
            `;
            container.appendChild(storeEl);
        }

        async function loadStoreDetail() {
            if (!currentStoreId) return;
            const contentEl = document.getElementById('store-detail-content');
            try {
                const storeResponse = await fetch(`/api/stores/${currentStoreId}`);
                const store = await storeResponse.json();
                const isFav = favoriteStoreIds.has(store.id);
                contentEl.innerHTML = `
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-3xl font-bold text-orange-600">${store.storeName}</h2>
                        <button onclick="toggleFavorite(${store.id})" class="text-3xl focus:outline-none">
                            <span id="fav-icon" class="${isFav ? 'text-yellow-400' : 'text-gray-300'}">${isFav ? '★' : '☆'}</span>
                        </button>
                    </div>
                    <p class="text-gray-600 mb-4">${store.address}</p>
                    <p class="text-gray-600 mb-6">${store.phoneNumber || '전화번호 없음'}</p>
                    <div class="flex space-x-4">
                        <button onclick="handleNavigate('store-menu', currentStoreId)" class="flex-1 bg-orange-500 text-white p-3 rounded-lg font-bold hover:bg-orange-600">메뉴 보기</button>
                        <button onclick="handleNavigate('reservation', currentStoreId)" class="flex-1 bg-green-600 text-white p-3 rounded-lg font-bold hover:bg-green-700">테이블 예약하기</button>
                    </div>`;
            } catch (e) { contentEl.innerHTML = '<p class="text-red-500">오류 발생.</p>'; }
        }

        async function loadStoreMenu() {
            if (!currentStoreId) return;
            const contentEl = document.getElementById('menu-category-content');
            try {
                const response = await fetch(`/ api / stores / ${currentStoreId}/products`);
                const products = await response.json();
                contentEl.innerHTML = '<h3 class="text-2xl font-bold mb-4">메뉴</h3><div class="space-y-4">';
                products.forEach(p => {
                    contentEl.innerHTML += `<div class="flex justify-between items-center border-b pb-2"><div><h4 class="font-bold">${p.name}</h4><p class="text-sm text-gray-500">${p.description || ''}</p></div><span class="font-bold text-orange-600">${p.price.toLocaleString()}원</span></div>`;
                });
                contentEl.innerHTML += '</div>';
            } catch (e) { contentEl.innerHTML = '<p class="text-red-500">오류 발생.</p>'; }
        }

        async function loadReservationMenus() {
            if (!currentStoreId) return;
            const categoryEl = document.getElementById('menu-categories');
            const listEl = document.getElementById('menu-list');
            try {
                const response = await fetch(`/api/stores/${currentStoreId}/products`);
                menuData = await response.json();
                const categories = [...new Set(menuData.map(p => p.category || '기타'))];
                categoryEl.innerHTML = `<button onclick="filterMenu('all')" class="px-3 py-1 bg-orange-500 text-white rounded-full text-sm whitespace-nowrap">전체</button>`;
                categories.forEach(cat => {
                    categoryEl.innerHTML += `<button onclick="filterMenu('${cat}')" class="px-3 py-1 bg-gray-200 text-gray-700 rounded-full text-sm whitespace-nowrap hover:bg-gray-300">${cat}</button>`;
                });
                filterMenu('all');
            } catch (e) { listEl.innerHTML = '<p class="text-red-500">오류 발생.</p>'; }
        }

        function filterMenu(category) {
            currentCategory = category; // Update global state
            const listEl = document.getElementById('menu-list');
            listEl.innerHTML = '';
            const filtered = category === 'all' ? menuData : menuData.filter(p => (p.category || '기타') === category);

            // Time Restriction Logic
            const timeVal = document.getElementById('res-time').value;
            let currentHour = -1;
            if (timeVal) {
                currentHour = parseInt(timeVal.split(':')[0]);
            }

            filtered.forEach(p => {
                const qty = selectedMenus[p.id] || 0;
                const item = document.createElement('div');
                item.className = 'flex justify-between items-center border-b pb-2';

                // Check restriction: Store ID 2 (Seyeonjeong) + "토마호그" + Time not 18~20
                let isRestricted = false;
                if (currentStoreId == 2 && p.name.includes('토마호그')) {
                    if (currentHour !== -1 && (currentHour < 18 || currentHour >= 20)) {
                        isRestricted = true;
                    }
                }

                if (isRestricted) {
                    item.innerHTML = `
                        <div class="flex-1 opacity-50">
                            <h4 class="font-bold">${p.name} <span class="text-red-500 text-xs ml-2">(18~20시까지만 판매)</span></h4>
                            <p class="text-xs text-gray-500">${p.price.toLocaleString()}원</p>
                        </div>
                        <div class="flex items-center space-x-2">
                            <button disabled class="w-6 h-6 bg-gray-100 text-gray-400 rounded-full flex items-center justify-center font-bold cursor-not-allowed">-</button>
                            <span class="w-4 text-center font-bold text-gray-400">0</span>
                            <button disabled class="w-6 h-6 bg-gray-100 text-gray-400 rounded-full flex items-center justify-center font-bold cursor-not-allowed">+</button>
                        </div>`;
                } else {
                    item.innerHTML = `
                        <div class="flex-1">
                            <h4 class="font-bold">${p.name}</h4>
                            <p class="text-xs text-gray-500">${p.price.toLocaleString()}원</p>
                        </div>
                        <div class="flex items-center space-x-2">
                            <button onclick="updateMenuQty(${p.id}, -1)" class="w-6 h-6 bg-gray-200 rounded-full flex items-center justify-center font-bold">-</button>
                            <span id="qty-${p.id}" class="w-4 text-center font-bold">${qty}</span>
                            <button onclick="updateMenuQty(${p.id}, 1)" class="w-6 h-6 bg-orange-500 text-white rounded-full flex items-center justify-center font-bold">+</button>
                        </div>`;
                }
                listEl.appendChild(item);
            });
        }

        function updateMenuQty(productId, delta) {
            if (!selectedMenus[productId]) selectedMenus[productId] = 0;
            selectedMenus[productId] += delta;
            if (selectedMenus[productId] < 0) selectedMenus[productId] = 0;
            document.getElementById(`qty-${productId}`).textContent = selectedMenus[productId];
            updateTotalPrice();
        }

        function updateTotalPrice() {
            let menuTotal = 0;
            let estTime = 0;

            for (const [pid, qty] of Object.entries(selectedMenus)) {
                if (qty > 0) {
                    const product = menuData.find(p => p.id == pid);
                    if (product) {
                        menuTotal += product.price * qty;
                        // Calculate time based on category
                        const cat = product.category || '기타';
                        const timePerItem = categoryTimeMap[cat] || 10;
                        estTime += timePerItem * qty;
                    }
                }
            }

            const total = currentTablePrice + menuTotal;
            document.getElementById('total-price').textContent = total.toLocaleString() + '원';

            // Base time 10 mins if any food ordered
            if (estTime > 0) estTime += 10;
            document.getElementById('est-time').textContent = estTime + '분';
        }

        async function handleBackendLogin() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            try {
                const response = await fetch(`${apiUrl}/login`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ email, password }) });
                if (response.ok) {
                    await checkLoginStatus(); // Re-fetch profile to get nickname
                    handleNavigate('home');
                }
                else { document.getElementById('login-message').textContent = '로그인 실패.'; }
            } catch (e) { console.error(e); }
        }

        async function handleBackendSignup() {
            const data = { username: document.getElementById('signup-user-name').value, email: document.getElementById('signup-email').value, phoneNumber: document.getElementById('signup-phone-number').value, password: document.getElementById('signup-password').value, nickname: document.getElementById('signup-user-name').value };
            try { const res = await fetch(`${apiUrl}/register`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) }); if (res.ok) { alert('가입 성공'); handleNavigate('login'); } } catch (e) { }
        }

        async function handleLogout() { await fetch('/api/auth/logout', { method: 'POST' }); currentUser = null; currentUserEmail = null; handleNavigate('home'); }

        async function handleWithdraw() {
            const password = document.getElementById('withdraw-password').value;
            try { const res = await fetch('/user/withdraw', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ password }) }); if (res.ok) { alert(await res.text()); currentUser = null; handleNavigate('home'); } else { alert('탈퇴 실패'); } } catch (e) { }
        }

        async function updateMyPageInfo() {
            const nickname = document.getElementById('mypage-nickname').value;
            const preferredFood = document.getElementById('mypage-food').value;

            try {
                const response = await fetch('/user/profile', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ nickname, preferredFood })
                });

                if (response.ok) {
                    alert('정보가 수정되었습니다.');
                    loadMyPageInfo(); // Reload to update state
                } else {
                    alert('수정 실패: ' + await response.text());
                }
            } catch (e) {
                alert('오류 발생: ' + e.message);
            }
        }

        async function loadMyPageInfo() {
            const emailEl = document.getElementById('mypage-email');
            const nicknameEl = document.getElementById('mypage-nickname');
            const foodEl = document.getElementById('mypage-food');
            try {
                const response = await fetch('/user/mypage');
                if (response.ok) {
                    const data = await response.json();
                    currentUserEmail = data.email;
                    currentUser = data.nickname || data.email; // Update global state
                    emailEl.textContent = data.email;
                    nicknameEl.value = data.nickname || '';
                    foodEl.value = data.preferredFood || '';
                    updateHeader(); // Re-render header if nickname changed
                }
            } catch (e) { }

            // Load Reservations
            const reservationContainer = document.createElement('div');
            reservationContainer.className = 'mt-8 border-t pt-6';
            reservationContainer.innerHTML = '<h3 class="text-2xl font-bold mb-4 text-orange-600">나의 예약</h3><div id="my-reservations" class="space-y-4"><p>예약 내역을 불러오는 중...</p></div>';
            const myPageContent = document.querySelector('#view-container .bg-white .space-y-4');
            if (myPageContent) {
                const oldRes = document.getElementById('my-reservations-container');
                if (oldRes) oldRes.remove();
                reservationContainer.id = 'my-reservations-container';
                myPageContent.appendChild(reservationContainer);
            }

            try {
                const response = await fetch('/api/reservations/my');
                if (response.ok) {
                    const reservations = await response.json();
                    const listEl = document.getElementById('my-reservations');
                    if (reservations.length === 0) listEl.innerHTML = '<p>예약 내역이 없습니다.</p>';
                    else {
                        listEl.innerHTML = '';
                        reservations.forEach(res => {
                            const item = document.createElement('div');
                            item.className = 'p-4 border rounded-lg bg-gray-50 shadow-sm';

                            let menuSummary = '';
                            if (res.menus && res.menus.length > 0) {
                                menuSummary = '<div class="mt-2 pt-2 border-t text-sm text-gray-600"><p class="font-bold">주문 메뉴:</p>';
                                res.menus.forEach(m => { menuSummary += `<p>- ${m.name} x ${m.quantity} (${(m.price * m.quantity).toLocaleString()}원)</p>`; });
                                menuSummary += '</div>';
                            }

                            // Payment Info
                            const paymentInfo = res.paymentMethod ? `<p class="text-sm text-blue-600 font-bold">결제: ${res.paymentMethod === 'CARD' ? '카드 결제' : '현장 결제'} ${res.paymentTime ? '(' + res.paymentTime.replace('T', ' ').substring(0, 16) + ')' : ''}</p>` : '';

                            item.innerHTML = `
                                <div class="flex justify-between items-center mb-2">
                                    <h4 class="font-bold text-lg text-orange-600">${res.storeName}</h4>
                                    <span class="text-sm text-gray-500 bg-white px-2 py-1 rounded border">${res.date} ${res.time}</span>
                                </div>
                                <div class="text-gray-700">
                                    <p><span class="font-semibold">테이블:</span> ${res.tableName}</p>
                                    <p><span class="font-semibold">인원:</span> ${res.partySize}명</p>
                                    ${menuSummary}
                                    <div class="flex justify-between items-end mt-2">
                                        ${paymentInfo}
                                        <p class="font-bold text-lg text-red-600">총 결제금액: ${res.totalPrice.toLocaleString()}원</p>
                                    </div>
                                </div>
                            `;
                            const btnContainer = document.createElement('div');
                            btnContainer.className = 'flex justify-end space-x-2 mt-2';
                            btnContainer.innerHTML = `
                                <button onclick="openModifyModal(${res.id}, '${res.date}', '${res.time}', ${res.partySize}, ${JSON.stringify(res.menus).replace(/"/g, '&quot;')})" class="bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600">변경</button>
                                <button onclick="cancelReservation(${res.id})" class="bg-red-500 text-white px-3 py-1 rounded text-sm hover:bg-red-600">취소</button>
                                <button onclick='showReceipt(${JSON.stringify(res).replace(/'/g, "&#39;")})' class="bg-gray-500 text-white px-3 py-1 rounded text-sm hover:bg-gray-600">영수증</button>
                            `;
                            item.appendChild(btnContainer);
                            listEl.appendChild(item);
                        });
                    }
                }
            } catch (e) { }
        }

        async function cancelReservation(id) {
            if (!confirm('취소하시겠습니까?')) return;
            await fetch(`/api/reservations/${id}`, { method: 'DELETE' });
            loadMyPageInfo();
        }

        let currentModifyingId = null;
        let modifyingMenus = {};
        function openModifyModal(id, date, time, partySize, currentMenus) {
            currentModifyingId = id; modifyingMenus = {};
            if (currentMenus) currentMenus.forEach(m => modifyingMenus[m.id] = m.quantity);
            let modal = document.getElementById('modify-modal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'modify-modal';
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden';
                modal.innerHTML = `
                    <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-md max-h-[90vh] overflow-y-auto">
                        <h3 class="text-xl font-bold mb-4">예약 변경</h3>
                        <input type="date" id="mod-date" class="w-full p-2 border rounded mb-2">
                        <input type="time" id="mod-time" class="w-full p-2 border rounded mb-2">
                        <input type="number" id="mod-party-size" class="w-full p-2 border rounded mb-4" min="1">
                        <div id="mod-menu-list" class="space-y-2 max-h-[200px] overflow-y-auto border p-2 rounded mb-4"></div>
                        <div class="flex justify-end space-x-2">
                            <button onclick="document.getElementById('modify-modal').classList.add('hidden')" class="bg-gray-300 px-4 py-2 rounded">취소</button>
                            <button onclick="submitModification()" class="bg-blue-600 text-white px-4 py-2 rounded">변경 확정</button>
                        </div>
                    </div>`;
                document.body.appendChild(modal);
            }
            document.getElementById('mod-date').value = date;
            document.getElementById('mod-time').value = time;
            document.getElementById('mod-party-size').value = partySize;
            const listEl = document.getElementById('mod-menu-list');
            if (menuData.length > 0) {
                listEl.innerHTML = '';
                menuData.forEach(p => {
                    const qty = modifyingMenus[p.id] || 0;
                    listEl.innerHTML += `<div class="flex justify-between items-center text-sm"><span>${p.name}</span><div class="flex items-center space-x-1"><button onclick="updateModMenuQty(${p.id}, -1)" class="px-2 bg-gray-200 rounded">-</button><span id="mod-qty-${p.id}">${qty}</span><button onclick="updateModMenuQty(${p.id}, 1)" class="px-2 bg-orange-200 rounded">+</button></div></div>`;
                });
            } else listEl.innerHTML = '메뉴 정보 없음';
            modal.classList.remove('hidden');
        }

        function updateModMenuQty(pid, d) { modifyingMenus[pid] = (modifyingMenus[pid] || 0) + d; if (modifyingMenus[pid] < 0) modifyingMenus[pid] = 0; document.getElementById(`mod-qty-${pid}`).textContent = modifyingMenus[pid]; }

        async function submitModification() {
            const date = document.getElementById('mod-date').value;
            const time = document.getElementById('mod-time').value;
            const partySize = document.getElementById('mod-party-size').value;
            const menus = [];
            for (const [pid, qty] of Object.entries(modifyingMenus)) if (qty > 0) menus.push({ productId: parseInt(pid), quantity: qty });
            await fetch(`/api/reservations/${currentModifyingId}`, {
                method: 'PUT', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ date, time, partySize: parseInt(partySize), menus })
            });
            document.getElementById('modify-modal').classList.add('hidden');
            loadMyPageInfo();
        }

        async function loadAvailableTimes() {
            const date = document.getElementById('res-date').value;
            const timeSelect = document.getElementById('res-time');
            try {
                const res = await fetch(`/api/reservations/times?date=${date}`);
                const times = await res.json();
                timeSelect.innerHTML = '<option value="">시간 선택</option>';
                times.forEach(t => {
                    const opt = document.createElement('option'); opt.value = t.time; opt.textContent = `${t.time} (${t.status})`; if (t.status === 'full') opt.disabled = true;
                    timeSelect.appendChild(opt);
                });
                timeSelect.disabled = false;
            } catch (e) { }
        }

        async function loadAvailableTables() {
            const date = document.getElementById('res-date').value;
            const time = document.getElementById('res-time').value;
            const partySize = document.getElementById('res-party-size').value;
            const listEl = document.getElementById('res-table-list');
            try {
                const res = await fetch(`/api/reservations/tables?storeId=${currentStoreId}&date=${date}&time=${time}&partySize=${partySize}`);
                const tables = await res.json();
                listEl.innerHTML = '';
                tables.forEach(t => {
                    listEl.innerHTML += `<div class="p-3 border rounded hover:bg-orange-50 cursor-pointer flex justify-between items-center"><div><span class="font-bold">${t.name}</span> <span class="text-sm">(${t.capacity})</span></div><button onclick="selectTable(this.closest('div'), ${t.id}, ${t.price})" class="bg-orange-500 text-white text-xs px-3 py-1 rounded">선택</button></div>`;
                });
                // Refresh menu to apply time restrictions
                filterMenu(currentCategory);
            } catch (e) { }
        }

        function selectTable(el, id, price) {
            const siblings = el.parentElement.children;
            for (let s of siblings) { s.classList.remove('bg-orange-100', 'border-orange-500'); s.querySelector('button').textContent = '선택'; s.querySelector('button').classList.replace('bg-green-600', 'bg-orange-500'); }
            el.classList.add('bg-orange-100', 'border-orange-500');
            el.querySelector('button').textContent = '선택됨';
            el.querySelector('button').classList.replace('bg-orange-500', 'bg-green-600');
            document.getElementById('res-table-id').value = id;
            currentTablePrice = price;
            updateTotalPrice();
        }

        async function handleReservationSubmit(event) {
            if (event) event.preventDefault();

            const date = document.getElementById('res-date').value;
            const time = document.getElementById('res-time').value;
            const partySize = document.getElementById('res-party-size').value;
            const tableId = document.getElementById('res-table-id').value;
            const paymentMethod = document.querySelector('input[name="payment-method"]:checked').value;

            if (!date || !time || !tableId) { alert('정보를 모두 입력하세요.'); return; }
            if (!currentUser) { alert('로그인 필요'); handleNavigate('login'); return; }

            const menus = [];
            for (const [pid, qty] of Object.entries(selectedMenus)) if (qty > 0) menus.push({ productId: parseInt(pid), quantity: qty });

            // PortOne Payment Integration
            if (paymentMethod === 'CARD') {
                // Calculate total amount
                let totalAmount = 0;
                totalAmount += currentTablePrice;

                for (const [pid, qty] of Object.entries(selectedMenus)) {
                    if (qty > 0) {
                        const product = menuData.find(p => p.id == pid);
                        if (product) totalAmount += product.price * qty;
                    }
                }

                IMP.request_pay({
                    pg: "kakaopay",
                    pay_method: "card",
                    merchant_uid: "ORD" + new Date().getTime(),
                    name: "바로잇 예약 결제",
                    amount: totalAmount,
                    buyer_email: currentUserEmail,
                    buyer_name: currentUser,
                    buyer_tel: "010-1234-5678", // Optional
                }, async function (rsp) {
                    if (rsp.success) {
                        // Payment Success - Verify with Backend
                        try {
                            const verifyRes = await fetch(`/api/payments/verify/${rsp.imp_uid}`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ imp_uid: rsp.imp_uid, merchant_uid: rsp.merchant_uid, amount: totalAmount })
                            });
                            const verifyData = await verifyRes.json();

                            if (verifyRes.ok) {
                                // Verification Success - Create Reservation
                                createReservation(tableId, date, time, partySize, menus, paymentMethod, rsp.imp_uid);
                            } else {
                                alert('결제 검증 실패: ' + verifyData.message);
                            }
                        } catch (e) {
                            alert('결제 검증 중 오류 발생');
                        }
                    } else {
                        alert('결제 실패: ' + rsp.error_msg);
                    }
                });
                return; // Stop here, wait for payment callback
            }

            // On-Site Payment
            createReservation(tableId, date, time, partySize, menus, paymentMethod, null);
        }

        async function createReservation(tableId, date, time, partySize, menus, paymentMethod, impUid) {
            try {
                const response = await fetch('/api/reservations', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ tableId, date, time, partySize: parseInt(partySize), menus, paymentMethod, impUid })
                });
                const result = await response.json();
                if (response.ok) {
                    alert('예약이 완료되었습니다!');
                    handleNavigate('mypage');
                } else { alert('실패: ' + result.message); }
            } catch (e) { alert('오류 발생: ' + e.message); }
        }

        // --- Receipt Modal ---
        function showReceipt(res) {
            let modal = document.getElementById('receipt-modal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'receipt-modal';
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                document.body.appendChild(modal);
            }
            modal.innerHTML = `
                <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-md">
                    <div class="flex justify-between items-center mb-6 border-b pb-4">
                        <h3 class="text-2xl font-bold text-orange-600">영수증</h3>
                        <button onclick="document.getElementById('receipt-modal').remove()" class="text-gray-500 hover:text-black text-xl">&times;</button>
                    </div>
                    <div class="space-y-4">
                        <div class="flex justify-between">
                            <span class="text-gray-600">매장명</span>
                            <span class="font-bold">${res.storeName}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">일시</span>
                            <span>${res.date} ${res.time}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">인원</span>
                            <span>${res.partySize}명</span>
                        </div>
                        <div class="border-t pt-4 mt-4">
                            <h4 class="font-bold mb-2">주문 내역</h4>
                            ${res.menus && res.menus.length > 0 ? res.menus.map(m => `<div class="flex justify-between text-sm"><span class="text-gray-600">${m.name} x ${m.quantity}</span><span>${(m.price * m.quantity).toLocaleString()}원</span></div>`).join('') : '<p class="text-sm text-gray-400">주문 메뉴 없음</p>'}
                        </div>
                        <div class="flex justify-between border-t pt-4 mt-4 font-bold text-lg">
                            <span>총 결제금액</span>
                            <span class="text-orange-600">${res.totalPrice.toLocaleString()}원</span>
                        </div>
                        <div class="mt-4 p-3 bg-gray-100 rounded text-center">
                            <p class="font-bold ${res.paymentMethod === 'ON_SITE' ? 'text-orange-600' : 'text-blue-600'}">
                                ${res.paymentMethod === 'ON_SITE' ? '결제 예정 (현장 결제)' : '결제 완료 (카드)'}
                            </p>
                            <p class="text-xs text-gray-500 mt-1">${res.paymentTime ? res.paymentTime.replace('T', ' ').substring(0, 16) : ''}</p>
                        </div>
                    </div>
                    <div class="mt-6 text-center text-xs text-gray-400">
                        본 영수증은 바로잇 결제 증빙용입니다.
                    </div>
                </div>
            `;
        }

        // --- Notification Logic ---
        async function checkUpcomingReservations() {
            if (!currentUser) return;
            try {
                const response = await fetch('/api/reservations/my');
                if (!response.ok) return;
                const reservations = await response.json();

                const now = new Date();
                reservations.forEach(res => {
                    const resTime = new Date(`${res.date}T${res.time}`);
                    const diffMs = resTime - now;
                    const diffMins = Math.floor(diffMs / 60000);

                    // Notify if within 30 mins (0 to 30) and not notified yet
                    if (diffMins > 0 && diffMins <= 30 && !notifiedReservations.has(res.id)) {
                        alert(`[알림] 예약 시간이 ${diffMins}분 남았습니다!\n매장: ${res.storeName} \n시간: ${res.time}`);
                        notifiedReservations.add(res.id);
                    }
                });
            } catch (e) { console.error("Notification check failed", e); }
        }

    </script>
</body>

</html>