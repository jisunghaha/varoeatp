<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë°”ë¡œì‡ - ì„œë¹„ìŠ¤</title>
    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=193769daf0c31ee061eba59ad214d977&libraries=services"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes bounce-gentle { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-3px); } }
        .bounce-gentle { animation: bounce-gentle 1.5s infinite; }
        .profile-img { object-fit: cover; }
        /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        .modal { transition: opacity 0.25s ease; }
        body.modal-active { overflow-x: hidden; overflow-y: visible !important; }
    </style>
</head>
<body class="bg-gray-50 font-sans">

<div id="app" class="min-h-screen flex flex-col relative">
    <header id="header-container"></header>
    <main id="view-container" class="flex-grow pb-24"></main> <div id="cart-bar" class="fixed bottom-0 left-0 w-full bg-white shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)] p-4 hidden z-40">
    <div class="container mx-auto max-w-4xl flex justify-between items-center">
        <div>
            <span class="text-gray-600 text-sm">ì´ ì£¼ë¬¸ ê¸ˆì•¡</span>
            <p id="cart-total-price" class="text-xl font-bold text-orange-600">0ì›</p>
        </div>
        <button onclick="openReservationModal()" class="bg-orange-500 text-white px-6 py-3 rounded-lg font-bold hover:bg-orange-600 shadow-lg transition transform active:scale-95">
            ì˜ˆì•½í•˜ê¸° (<span id="cart-count">0</span>)
        </button>
    </div>
</div>

    <div id="reservation-modal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-50">
        <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-50"></div>

        <div class="modal-container bg-white w-11/12 md:max-w-md mx-auto rounded shadow-lg z-50 overflow-y-auto max-h-[90vh]">
            <div class="modal-content py-4 text-left px-6">
                <div class="flex justify-between items-center pb-3 border-b">
                    <p class="text-2xl font-bold text-orange-600">ì˜ˆì•½ ì •ë³´ ì…ë ¥</p>
                    <div class="modal-close cursor-pointer z-50" onclick="closeReservationModal()">
                        <svg class="fill-current text-black" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 18 18">
                            <path d="M14.53 4.53l-1.06-1.06L9 7.94 4.53 3.47 3.47 4.53 7.94 9l-4.47 4.47 1.06 1.06L9 10.06l4.47 4.47 1.06-1.06L10.06 9z"></path>
                        </svg>
                    </div>
                </div>

                <div class="my-5 space-y-4">
                    <div>
                        <label class="block text-sm font-bold mb-2">ë‚ ì§œ</label>
                        <input type="date" id="res-date" class="w-full p-2 border rounded">
                    </div>
                    <div>
                        <label class="block text-sm font-bold mb-2">ì‹œê°„</label>
                        <select id="res-time" class="w-full p-2 border rounded">
                            <option value="">ì‹œê°„ ì„ íƒ</option>
                            <option value="11:00">11:00</option><option value="11:30">11:30</option>
                            <option value="12:00">12:00</option><option value="12:30">12:30</option>
                            <option value="13:00">13:00</option><option value="13:30">13:30</option>
                            <option value="17:00">17:00</option><option value="17:30">17:30</option>
                            <option value="18:00">18:00</option><option value="18:30">18:30</option>
                            <option value="19:00">19:00</option><option value="19:30">19:30</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-bold mb-2">ì¸ì›</label>
                        <input type="number" id="res-party" min="1" value="2" class="w-full p-2 border rounded">
                    </div>

                    <div class="bg-gray-50 p-3 rounded mt-4">
                        <h4 class="font-bold text-sm mb-2">ì£¼ë¬¸ ë‚´ì—­</h4>
                        <ul id="modal-cart-list" class="text-sm text-gray-600 space-y-1"></ul>
                        <hr class="my-2">
                        <p class="text-right font-bold text-orange-600" id="modal-total-price">0ì›</p>
                    </div>
                </div>

                <div class="flex justify-end pt-2">
                    <button onclick="closeReservationModal()" class="px-4 bg-transparent p-3 rounded-lg text-orange-500 hover:bg-gray-100 hover:text-orange-400 mr-2">ì·¨ì†Œ</button>
                    <button onclick="submitReservation()" class="px-4 bg-orange-500 p-3 rounded-lg text-white hover:bg-orange-400 font-bold">ì˜ˆì•½ í™•ì •</button>
                </div>
            </div>
        </div>
    </div>

    <footer class="bg-gradient-to-r from-orange-900 to-red-900 text-white py-12 mt-16">
        <div class="container mx-auto px-4">
            <div class="text-center">
                <div class="flex items-center justify-center space-x-3 mb-4">
                    <div class="w-10 h-10 rounded-lg bg-yellow-400 flex items-center justify-center text-xl font-bold text-orange-900">ì‡</div>
                    <span class="font-bold text-xl">ë°”ë¡œì‡</span>
                </div>
                <p class="text-sm text-orange-100">ìƒˆë¡œìš´ ì‹ì‚¬ ê²½í—˜ì˜ ì‹œì‘</p>
            </div>
        </div>
    </footer>
</div>

<script>
    // ==========================================
    //  ì „ì—­ ë³€ìˆ˜ ë° ì„¤ì •
    // ==========================================
    let currentView = 'home';
    let currentUser = null;
    let currentStoreId = null;

    // ì¥ë°”êµ¬ë‹ˆ ë°ì´í„°: { productId: { name, price, count } }
    let cart = {};

    const headerContainer = document.getElementById('header-container');
    const viewContainer = document.getElementById('view-container');
    const apiUrl = '/api/auth';

    // ìŒì‹ ì¢…ë¥˜ ë°ì´í„°
    const FOOD_TYPES = {
        "KOREAN": "í•œì‹", "CHINESE": "ì¤‘ì‹", "JAPANESE": "ì¼ì‹",
        "WESTERN": "ì–‘ì‹", "SNACK": "ë¶„ì‹", "CHICKEN": "ì¹˜í‚¨",
        "PIZZA": "í”¼ì", "FASTFOOD": "íŒ¨ìŠ¤íŠ¸í‘¸ë“œ", "JOKBAL_BOSSAM": "ì¡±ë°œ/ë³´ìŒˆ",
        "ASIAN": "ì•„ì‹œì•ˆ", "MEXICAN": "ë©•ì‹œì¹¸", "LUNCHBOX": "ë„ì‹œë½",
        "SALAD": "ìƒëŸ¬ë“œ", "CAFE": "ì¹´í˜", "DESERT": "ë””ì €íŠ¸",
        "MEAT": "ê³ ê¸°/êµ¬ì´", "BAR": "ìˆ ì§‘"
    };

    // ==========================================
    //  1. ë„¤ë¹„ê²Œì´ì…˜ ë° í™”ë©´ ë Œë”ë§
    // ==========================================
    function handleNavigate(page, id = null) {
        currentView = page;
        currentStoreId = id;

        // ì¥ë°”êµ¬ë‹ˆ UI ì œì–´
        const cartBar = document.getElementById('cart-bar');
        if (page === 'store-detail') {
            // ë§¤ì¥ ìƒì„¸ì—ì„œë§Œ ì¥ë°”êµ¬ë‹ˆ ë³´ì„ (ë‚´ìš©ì´ ìˆìœ¼ë©´)
            updateCartUI();
        } else {
            cartBar.classList.add('hidden');
            cart = {}; // ë‹¤ë¥¸ í˜ì´ì§€ë¡œ ì´ë™ ì‹œ ì¥ë°”êµ¬ë‹ˆ ì´ˆê¸°í™”
        }
        render();
    }

    async function render() {
        if (currentUser === null) { await checkLoginStatus(); }
        renderHeader();
        renderView();
    }

    function renderHeader() {
        if (currentView === 'login' || currentView === 'signup') {
            headerContainer.innerHTML = ''; return;
        }
        const authButtons = currentUser
            ? `<div class="flex items-center space-x-4">
                   <span class="font-medium text-gray-700">${currentUser}ë‹˜</span>
                   <button onclick="handleNavigate('mypage')" class="bg-orange-100 text-orange-600 px-3 py-1 rounded-full text-sm font-semibold hover:bg-orange-200">ë§ˆì´í˜ì´ì§€</button>
                   <button onclick="handleLogout()" class="bg-gray-200 text-gray-600 px-3 py-1 rounded-full text-sm font-semibold hover:bg-gray-300">ë¡œê·¸ì•„ì›ƒ</button>
               </div>`
            : `<button onclick="handleNavigate('login')" class="bg-orange-500 text-white px-4 py-2 rounded-full text-sm font-semibold hover:bg-orange-600">ë¡œê·¸ì¸ / ê°€ì…</button>`;

        headerContainer.innerHTML = `
            <div class="sticky top-0 z-50 bg-white shadow-md">
                <div class="container mx-auto px-4 py-4 flex items-center justify-between">
                    <div class="flex items-center space-x-3 cursor-pointer" onclick="handleNavigate('home')">
                        <div class="w-8 h-8 rounded-lg bounce-gentle bg-yellow-400 flex items-center justify-center text-lg font-bold text-orange-900">ì‡</div>
                        <span class="font-bold text-xl text-orange-600">ë°”ë¡œì‡</span>
                    </div>
                    <div class="flex items-center space-x-4">${authButtons}</div>
                </div>
            </div>`;
    }

    function renderView() {
        switch (currentView) {
            case 'home':
                viewContainer.innerHTML = `
                    <div class="container mx-auto px-4 py-8">
                        <section class="text-center py-24 bg-white rounded-xl shadow-lg">
                            <h1 class="text-5xl font-extrabold mb-4 text-orange-600">ë°”ë¡œ ì˜ˆì•½í•˜ê³  ë°”ë¡œ ì‡ì!</h1>
                            <p class="text-lg text-gray-600 mb-8">ê¸°ë‹¤ë¦¬ì§€ ë§ê³  ë°”ë¡œ ë“œì„¸ìš”.</p>
                            <button onclick="handleNavigate('store-list')" class="bg-orange-500 text-white px-6 py-3 rounded-full text-lg font-semibold hover:bg-orange-600">ë§¤ì¥ ì°¾ìœ¼ëŸ¬ ê°€ê¸°</button>
                        </section>
                    </div>`;
                break;

            case 'store-list':
                viewContainer.innerHTML = `
                    <div class="container mx-auto px-4 py-8">
                        <h1 class="text-3xl font-bold mb-6 text-orange-600">ì£¼ë³€ ë§¤ì¥ ì°¾ê¸°</h1>
                        <div class="flex flex-col md:flex-row gap-6">
                            <div id="map" class="w-full md:w-2/3 h-[600px] rounded-lg shadow-md"></div>
                            <div id="store-list-sidebar" class="w-full md:w-1/3 h-[600px] overflow-y-auto bg-white p-4 rounded-lg shadow-md">
                                <p>ë§¤ì¥ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p>
                            </div>
                        </div>
                    </div>`;
                setTimeout(loadStoresAndMap, 10);
                break;

            case 'store-detail':
                viewContainer.innerHTML = `
                    <div class="container mx-auto px-4 py-8 max-w-3xl">
                        <div id="store-detail-content" class="bg-white p-8 rounded-xl shadow-lg mb-6">
                            <p class="text-lg text-gray-600">ë§¤ì¥ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                        </div>
                        <div id="store-menu-content" class="bg-white p-8 rounded-xl shadow-lg pb-20">
                             <p class="text-lg text-gray-600">ë©”ë‰´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                        </div>
                        <button onclick="handleNavigate('store-list')" class="mt-6 bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300">ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
                    </div>`;
                loadStoreDetail();
                break;

            case 'login':
                viewContainer.innerHTML = `
                    <div class="container mx-auto py-16 max-w-md">
                        <div class="bg-white p-8 rounded-xl shadow-lg">
                            <h2 class="text-3xl font-bold mb-6 text-center text-orange-600">ë¡œê·¸ì¸</h2>
                            <div class="space-y-6">
                                <input type="email" id="login-email" placeholder="ì´ë©”ì¼" class="w-full p-3 border rounded-lg">
                                <input type="password" id="login-password" placeholder="ë¹„ë°€ë²ˆí˜¸" class="w-full p-3 border rounded-lg">
                                <button onclick="handleBackendLogin()" class="w-full bg-orange-500 text-white p-3 rounded-lg font-bold hover:bg-orange-600">ë¡œê·¸ì¸</button>
                                <a href="/oauth2/authorization/kakao" class="block w-full bg-[#FEE500] text-black p-3 rounded-lg font-bold text-center">ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸</a>
                                <button class="w-full text-gray-500 hover:text-orange-500" onclick="handleNavigate('signup')">íšŒì›ê°€ì…</button>
                            </div>
                        </div>
                    </div>`;
                break;
            case 'signup':
                viewContainer.innerHTML = `
                    <div class="container mx-auto py-16 max-w-md">
                        <div class="bg-white p-8 rounded-xl shadow-lg">
                            <h2 class="text-3xl font-bold mb-6 text-center text-orange-600">íšŒì›ê°€ì…</h2>
                            <div class="space-y-4">
                                <input type="text" id="signup-user-name" placeholder="ì´ë¦„ (ì‹¤ëª…)" class="w-full p-3 border rounded-lg">
                                <input type="text" id="signup-nickname" placeholder="ë‹‰ë„¤ì„ (ë³„ëª…)" class="w-full p-3 border rounded-lg">
                                <input type="email" id="signup-email" placeholder="ì´ë©”ì¼" class="w-full p-3 border rounded-lg">
                                <input type="tel" id="signup-phone-number" placeholder="íœ´ëŒ€í° ë²ˆí˜¸" class="w-full p-3 border rounded-lg">
                                <input type="password" id="signup-password" placeholder="ë¹„ë°€ë²ˆí˜¸" class="w-full p-3 border rounded-lg">
                                <button onclick="handleBackendSignup()" class="w-full bg-orange-500 text-white p-3 rounded-lg font-bold hover:bg-orange-600">ê°€ì…í•˜ê¸°</button>
                            </div>
                        </div>
                    </div>`;
                break;
            case 'mypage':
                viewContainer.innerHTML = `
                    <div class="container mx-auto py-8 px-4 max-w-4xl">
                        <div class="grid md:grid-cols-3 gap-6">
                            <div class="md:col-span-1">
                                <div class="bg-white p-6 rounded-xl shadow-lg text-center">
                                    <div class="relative w-32 h-32 mx-auto mb-4 group">
                                        <img id="profile-img-display" src="https://via.placeholder.com/150" class="w-full h-full rounded-full profile-img border-4 border-orange-100 shadow-sm">
                                        <label id="profile-img-label" for="profile-img-input" class="hidden absolute bottom-0 right-0 bg-orange-500 text-white p-2 rounded-full cursor-pointer hover:bg-orange-600 shadow-md">ğŸ“·</label>
                                        <input type="file" id="profile-img-input" class="hidden" accept="image/*" onchange="handleImageUpload(this)">
                                    </div>
                                    <h3 id="mypage-nickname" class="text-xl font-bold mb-1">ë¡œë”©ì¤‘...</h3>
                                    <p id="mypage-email" class="text-sm text-gray-500 mb-4"></p>
                                    <hr class="my-4">
                                    <button onclick="handleLogout()" class="text-sm text-gray-500 underline hover:text-red-500">ë¡œê·¸ì•„ì›ƒ</button>
                                </div>
                            </div>
                            <div class="md:col-span-2 space-y-6">
                                <div class="bg-white p-6 rounded-xl shadow-lg">
                                    <div class="flex justify-between items-center mb-4">
                                        <h3 class="text-xl font-bold text-gray-800">ë‚´ ì •ë³´</h3>
                                        <button id="btn-edit-mode" onclick="toggleEditMode(true)" class="text-sm bg-gray-100 px-3 py-1 rounded hover:bg-gray-200">âœ ìˆ˜ì •í•˜ê¸°</button>
                                    </div>
                                    <div id="view-mode-container">
                                        <div class="mb-4">
                                            <p class="text-sm text-gray-500">ë‹‰ë„¤ì„</p>
                                            <p id="view-nickname" class="text-lg font-medium text-gray-800">-</p>
                                        </div>
                                        <div class="mb-4">
                                            <p class="text-sm text-gray-500 mb-2">ì„ í˜¸í•˜ëŠ” ìŒì‹</p>
                                            <div id="view-food-tags" class="flex flex-wrap gap-2"></div>
                                        </div>
                                    </div>
                                    <div id="edit-mode-container" class="hidden space-y-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">ë‹‰ë„¤ì„ ë³€ê²½</label>
                                            <input type="text" id="edit-nickname" class="w-full p-2 border rounded-lg">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">ì„ í˜¸í•˜ëŠ” ìŒì‹ ì„ íƒ</label>
                                            <div id="food-checkbox-container" class="grid grid-cols-3 gap-2 bg-gray-50 p-3 rounded-lg border"></div>
                                        </div>
                                        <div class="flex gap-2 pt-2">
                                            <button onclick="handleUpdateProfile()" class="flex-1 bg-orange-500 text-white py-2 rounded-lg font-bold">ì €ì¥ ì™„ë£Œ</button>
                                            <button onclick="toggleEditMode(false)" class="flex-1 bg-gray-200 text-gray-700 py-2 rounded-lg font-bold">ì·¨ì†Œ</button>
                                        </div>
                                    </div>
                                </div>
                                <div class="bg-white p-6 rounded-xl shadow-lg">
                                    <h3 class="text-xl font-bold mb-4 text-gray-800">ğŸ“‹ ë‚˜ì˜ ì˜ˆì•½ ë‚´ì—­</h3>
                                    <div class="overflow-x-auto">
                                        <table class="w-full text-sm text-left">
                                            <thead class="bg-gray-50 text-gray-600"><tr><th class="p-3">ê°€ê²Œëª…</th><th class="p-3">ì‹œê°„</th><th class="p-3">ì¸ì›</th><th class="p-3">ê´€ë¦¬</th></tr></thead>
                                            <tbody id="reservation-list-body"><tr><td colspan="4" class="p-4 text-center">ë¡œë”©ì¤‘...</td></tr></tbody>
                                        </table>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <button onclick="toggleWithdraw()" class="text-xs text-red-400 underline">íšŒì› íƒˆí‡´í•˜ê¸°</button>
                                    <div id="withdraw-area" class="hidden mt-2 bg-red-50 p-4 rounded-lg text-left">
                                        <input type="password" id="withdraw-password" placeholder="ë¹„ë°€ë²ˆí˜¸" class="w-full p-2 text-sm border rounded mb-2">
                                        <button onclick="handleWithdraw()" class="bg-red-500 text-white px-3 py-1 rounded text-xs font-bold">í™•ì¸</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>`;
                loadFullMyPage();
                break;
        }
    }

    // ==========================================
    //  2. ì¸ì¦ ë° ì‚¬ìš©ì ê´€ë¦¬ (ëˆ„ë½ë˜ì—ˆë˜ ë¶€ë¶„ ë³µêµ¬)
    // ==========================================
    async function checkLoginStatus() {
        try {
            const response = await fetch(`${apiUrl}/me`);
            currentUser = response.ok ? await response.text() : null;
        } catch (e) { currentUser = null; }
    }

    async function handleBackendLogin() {
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;
        try {
            const response = await fetch(`${apiUrl}/login`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, password })
            });
            if (response.ok) {
                currentUser = await response.text();
                handleNavigate('home');
            } else { alert('ë¡œê·¸ì¸ ì‹¤íŒ¨'); }
        } catch (e) { console.error(e); }
    }

    async function handleBackendSignup() {
        const signupData = {
            username: document.getElementById('signup-user-name').value,
            nickname: document.getElementById('signup-nickname').value,
            email: document.getElementById('signup-email').value,
            phoneNumber: document.getElementById('signup-phone-number').value,
            password: document.getElementById('signup-password').value
        };
        try {
            const response = await fetch(`${apiUrl}/register`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(signupData)
            });
            if (response.ok) {
                alert('ê°€ì… ì„±ê³µ!');
                handleNavigate('login');
            } else { alert('ê°€ì… ì‹¤íŒ¨: ' + await response.text()); }
        } catch (e) { console.error(e); }
    }

    async function handleLogout() {
        await fetch('/api/auth/logout', { method: 'POST' });
        currentUser = null;
        alert('ë¡œê·¸ì•„ì›ƒë˜ì—ˆìŠµë‹ˆë‹¤.');
        handleNavigate('home');
    }

    // ==========================================
    //  3. ë§ˆì´í˜ì´ì§€ ë° ë°ì´í„° ë¡œë“œ
    // ==========================================
    async function loadFullMyPage() {
        const chkContainer = document.getElementById('food-checkbox-container');
        let html = '';
        for (const [key, value] of Object.entries(FOOD_TYPES)) {
            html += `<label class="flex items-center space-x-2 text-sm cursor-pointer hover:bg-gray-100 p-1 rounded">
                        <input type="checkbox" value="${key}" class="food-chk form-checkbox text-orange-500 rounded">
                        <span>${value}</span>
                     </label>`;
        }
        chkContainer.innerHTML = html;

        try {
            const res = await fetch('/user/mypage');
            if (res.status === 401) { handleNavigate('login'); return; }
            const data = await res.json();

            document.getElementById('mypage-nickname').textContent = data.nickname || currentUser;
            document.getElementById('mypage-email').textContent = data.email;
            document.getElementById('view-nickname').textContent = data.nickname || "(ë³„ëª… ì—†ìŒ)";

            const viewTags = document.getElementById('view-food-tags');
            if (data.preferredFoods && data.preferredFoods.length > 0) {
                viewTags.innerHTML = data.preferredFoods.map(code =>
                    `<span class="bg-orange-100 text-orange-700 px-2 py-1 rounded-full text-xs font-semibold">${FOOD_TYPES[code] || code}</span>`
                ).join('');
            } else {
                viewTags.innerHTML = '<span class="text-gray-400 text-sm">ì—†ìŒ</span>';
            }

            document.getElementById('edit-nickname').value = data.nickname || "";
            if (data.preferredFoods) {
                const checkboxes = document.querySelectorAll('.food-chk');
                checkboxes.forEach(chk => { if (data.preferredFoods.includes(chk.value)) chk.checked = true; });
            }
            if (data.profileImageUrl) {
                document.getElementById('profile-img-display').src = data.profileImageUrl + "?t=" + new Date().getTime();
            }
        } catch (e) { console.error(e); }
        loadReservations();
    }

    function toggleEditMode(isEdit) {
        const viewMode = document.getElementById('view-mode-container');
        const editMode = document.getElementById('edit-mode-container');
        const btnEdit = document.getElementById('btn-edit-mode');
        const imgLabel = document.getElementById('profile-img-label');

        if (isEdit) {
            viewMode.classList.add('hidden');
            editMode.classList.remove('hidden');
            btnEdit.classList.add('hidden');
            imgLabel.classList.remove('hidden');
        } else {
            viewMode.classList.remove('hidden');
            editMode.classList.add('hidden');
            btnEdit.classList.remove('hidden');
            imgLabel.classList.add('hidden');
        }
    }

    async function handleUpdateProfile() {
        const nickname = document.getElementById('edit-nickname').value;
        const checkedFoods = [];
        document.querySelectorAll('.food-chk:checked').forEach(chk => checkedFoods.push(chk.value));

        try {
            const res = await fetch('/user/profile', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ nickname: nickname, preferredFoods: checkedFoods })
            });
            if (res.ok) {
                alert('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
                toggleEditMode(false);
                loadFullMyPage();
            } else { alert('ìˆ˜ì • ì‹¤íŒ¨'); }
        } catch (e) { alert('ì˜¤ë¥˜ ë°œìƒ'); }
    }

    async function handleImageUpload(input) {
        if (!input.files || !input.files[0]) return;
        const formData = new FormData();
        formData.append('file', input.files[0]);
        try {
            const res = await fetch('/user/profile/image', { method: 'POST', body: formData });
            const data = await res.json();
            if (data.imageUrl) {
                document.getElementById('profile-img-display').src = data.imageUrl + "?t=" + new Date().getTime();
            } else { alert('ì—…ë¡œë“œ ì‹¤íŒ¨'); }
        } catch (e) { alert('ì—…ë¡œë“œ ì˜¤ë¥˜'); }
    }

    async function loadReservations() {
        try {
            const res = await fetch('/user/reservations');
            const list = await res.json();
            const tbody = document.getElementById('reservation-list-body');
            if (list.length === 0) { tbody.innerHTML = '<tr><td colspan="4" class="p-4 text-center text-gray-500">ì˜ˆì•½ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>'; return; }
            let rows = '';
            list.forEach(item => {
                rows += `<tr class="border-b hover:bg-gray-50">
                            <td class="p-3 font-medium">${item.storeName}</td>
                            <td class="p-3 text-gray-600 text-xs">${item.reservationTime}</td>
                            <td class="p-3">${item.partySize}ëª…</td>
                            <td class="p-3">
                                <button onclick="alert('ì·¨ì†Œ ê¸°ëŠ¥ì€ ê³§ êµ¬í˜„ë©ë‹ˆë‹¤.')" class="bg-red-100 text-red-600 px-2 py-1 rounded text-xs hover:bg-red-200">ì·¨ì†Œ</button>
                            </td>
                         </tr>`;
            });
            tbody.innerHTML = rows;
        } catch (e) { console.error(e); }
    }

    function toggleWithdraw() { document.getElementById('withdraw-area').classList.toggle('hidden'); }

    async function handleWithdraw() {
        const pw = document.getElementById('withdraw-password').value;
        if(!pw) return alert('ë¹„ë°€ë²ˆí˜¸ ì…ë ¥');
        if(!confirm('íƒˆí‡´í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
        try {
            const res = await fetch('/user/withdraw', {
                method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({password: pw})
            });
            if(res.ok) { alert('íƒˆí‡´ ì™„ë£Œ'); currentUser = null; handleNavigate('home'); }
            else { alert('íƒˆí‡´ ì‹¤íŒ¨: ' + await res.text()); }
        } catch(e) { alert('ì˜¤ë¥˜'); }
    }

    // ==========================================
    //  4. ë§¤ì¥ ë° ì¥ë°”êµ¬ë‹ˆ
    // ==========================================
    async function loadStoresAndMap() {
        const mapContainer = document.getElementById('map');
        const mapOption = { center: new kakao.maps.LatLng(35.148, 129.038), level: 4 };
        const map = new kakao.maps.Map(mapContainer, mapOption);
        const listSidebar = document.getElementById('store-list-sidebar');
        try {
            const response = await fetch('/api/stores');
            const stores = await response.json();
            if (stores.length === 0) { listSidebar.innerHTML = '<p>ë§¤ì¥ ì—†ìŒ</p>'; return; }
            listSidebar.innerHTML = '';
            stores.forEach(store => {
                const lat = parseFloat(store.lat);
                const lng = parseFloat(store.lng);
                if (!isNaN(lat) && !isNaN(lng)) {
                    const marker = new kakao.maps.Marker({ position: new kakao.maps.LatLng(lat, lng) });
                    marker.setMap(map);
                    kakao.maps.event.addListener(marker, 'click', () => handleNavigate('store-detail', store.id));
                    const storeEl = document.createElement('div');
                    storeEl.className = 'p-4 border-b hover:bg-gray-100 cursor-pointer';
                    storeEl.onclick = () => handleNavigate('store-detail', store.id);
                    storeEl.innerHTML = `<h3 class="font-bold text-lg">${store.storeName}</h3><p class="text-sm text-gray-600">${store.address}</p>`;
                    listSidebar.appendChild(storeEl);
                }
            });
            if (stores.length > 0) map.setCenter(new kakao.maps.LatLng(stores[0].lat, stores[0].lng));
        } catch (error) { console.error(error); }
    }

    async function loadStoreDetail() {
        if (!currentStoreId) return;
        try {
            // 1. ë§¤ì¥ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
            const res = await fetch(`/api/stores/${currentStoreId}`);
            const store = await res.json();

            document.getElementById('store-detail-content').innerHTML = `
                <h1 class="text-4xl font-extrabold mb-4 text-orange-600">${store.storeName}</h1>
                <p class="text-lg">ì£¼ì†Œ: ${store.address}</p>
                <p class="text-lg">ì „í™”: ${store.phoneNumber}</p>
                <p class="text-lg font-bold mt-2">${store.isOpen ? 'ì˜ì—… ì¤‘ ğŸŸ¢' : 'ì˜ì—… ì¢…ë£Œ ğŸ”´'}</p>
            `;

            // 2. ë©”ë‰´(ìƒí’ˆ) ì •ë³´ ê°€ì ¸ì˜¤ê¸°
            const prodRes = await fetch(`/api/stores/${currentStoreId}/products`);
            const products = await prodRes.json();

            let menuHtml = '<h2 class="text-2xl font-bold mb-4 text-gray-800">ë©”ë‰´</h2>';

            if (products.length === 0) {
                menuHtml += '<p class="text-gray-500">ë“±ë¡ëœ ë©”ë‰´ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
            } else {
                menuHtml += '<div class="grid gap-4">';
                products.forEach(p => {
                    const imgHtml = p.imageUrl ? `<img src="/images/${p.imageUrl}" class="w-20 h-20 object-cover rounded-lg mr-4">` : '';

                    menuHtml += `
                        <div class="flex items-center justify-between bg-gray-50 p-4 rounded-lg border hover:shadow-md transition">
                            <div class="flex items-center">
                                ${imgHtml}
                                <div>
                                    <h3 class="font-bold text-lg">${p.name}</h3>
                                    <p class="text-sm text-gray-600 mb-1">${p.description || ''}</p>
                                    <span class="text-orange-600 font-bold">${p.price.toLocaleString()}ì›</span>
                                </div>
                            </div>
                            <button onclick="addToCart(${p.id}, '${p.name}', ${p.price})" class="bg-white border border-orange-500 text-orange-500 px-3 py-1 rounded-lg hover:bg-orange-50 transition text-sm font-bold">
                                + ë‹´ê¸°
                            </button>
                        </div>
                    `;
                });
                menuHtml += '</div>';
            }

            document.getElementById('store-menu-content').innerHTML = menuHtml;

        } catch (e) { console.error(e); }
    }

    // ì¥ë°”êµ¬ë‹ˆ ë¡œì§
    function addToCart(id, name, price) {
        if (!cart[id]) {
            cart[id] = { name: name, price: price, count: 0 };
        }
        cart[id].count++;
        updateCartUI();
    }

    function updateCartUI() {
        const cartBar = document.getElementById('cart-bar');
        const totalCountEl = document.getElementById('cart-count');
        const totalPriceEl = document.getElementById('cart-total-price');

        let totalCount = 0;
        let totalPrice = 0;

        for (const id in cart) {
            totalCount += cart[id].count;
            totalPrice += cart[id].price * cart[id].count;
        }

        totalCountEl.innerText = totalCount;
        totalPriceEl.innerText = totalPrice.toLocaleString() + "ì›";

        if (totalCount > 0) {
            cartBar.classList.remove('hidden');
        } else {
            cartBar.classList.add('hidden');
        }
    }

    function openReservationModal() {
        if (!currentUser) {
            alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
            handleNavigate('login');
            return;
        }

        const modal = document.getElementById('reservation-modal');
        const modalCartList = document.getElementById('modal-cart-list');
        const modalTotalPrice = document.getElementById('modal-total-price');

        modal.classList.remove('opacity-0', 'pointer-events-none');
        document.body.classList.add('modal-active');

        document.getElementById('res-date').valueAsDate = new Date();

        let html = '';
        let total = 0;
        for (const id in cart) {
            const item = cart[id];
            if(item.count > 0) {
                html += `<li class="flex justify-between">
                            <span>${item.name} x ${item.count}</span>
                            <span>${(item.price * item.count).toLocaleString()}ì›</span>
                         </li>`;
                total += item.price * item.count;
            }
        }
        modalCartList.innerHTML = html;
        modalTotalPrice.innerText = "ì´ " + total.toLocaleString() + "ì›";
    }

    function closeReservationModal() {
        const modal = document.getElementById('reservation-modal');
        modal.classList.add('opacity-0', 'pointer-events-none');
        document.body.classList.remove('modal-active');
    }

    async function submitReservation() {
        const date = document.getElementById('res-date').value;
        const time = document.getElementById('res-time').value;
        const partySize = document.getElementById('res-party').value;

        if (!date || !time || !partySize) {
            alert("ë‚ ì§œ, ì‹œê°„, ì¸ì›ì„ ëª¨ë‘ ì„ íƒí•´ì£¼ì„¸ìš”.");
            return;
        }

        const items = [];
        for (const id in cart) {
            if (cart[id].count > 0) {
                items.push({ productId: parseInt(id), count: cart[id].count });
            }
        }

        try {
            const tableRes = await fetch(`/api/reservations/tables?date=${date}&time=${time}&partySize=${partySize}`);
            const tables = await tableRes.json();

            if (tables.length === 0) {
                alert("í•´ë‹¹ ì‹œê°„ì—ëŠ” ì˜ˆì•½ ê°€ëŠ¥í•œ í…Œì´ë¸”ì´ ì—†ìŠµë‹ˆë‹¤.");
                return;
            }

            const targetTableId = tables[0].id;

            const payload = {
                date: date,
                time: time,
                partySize: parseInt(partySize),
                tableId: targetTableId,
                items: items
            };

            const res = await fetch('/api/reservations', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (res.ok) {
                alert("ì˜ˆì•½ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!");
                closeReservationModal();
                cart = {};
                updateCartUI();
                handleNavigate('mypage');
            } else {
                const error = await res.json();
                alert("ì˜ˆì•½ ì‹¤íŒ¨: " + error.message);
            }

        } catch (e) {
            console.error(e);
            alert("ì˜¤ë¥˜ ë°œìƒ: " + e.message);
        }
    }

    // ì´ˆê¸°í™” ì‹¤í–‰
    render();
</script>
</body>
</html>